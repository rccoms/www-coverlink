<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoverLink - 대시보드</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-left">
                <div class="logo">CoverLink</div>
                <a href="admin/dashboard.html" class="back-link" style="margin-left: 16px;">관리자</a>
            </div>
            <div class="user-profile">
                <img id="user-avatar" src="" alt="Profile" class="avatar">
                <span id="user-name" class="username">User</span>
                <button id="logout-btn" class="logout-btn">로그아웃</button>
            </div>
        </header>

        <main class="dashboard-content">
            <div class="welcome-card">
                <h1 id="welcome-message">환영합니다!</h1>
                <p>로그인이 성공적으로 완료되었습니다.</p>
                <div class="status-section">
                    <p class="status-label">[현재 내 차 상태]</p>
                    <div class="status-main">
                        <span id="status-dot" class="status-dot status-available"></span>
                        <span id="status-title" class="status-title">바로 연결 가능</span>
                    </div>
                    <p id="status-description" class="status-description">
                        지금 누군가 호출하면 즉시 전화가 연결됩니다.
                    </p>
                    <hr class="status-divider" />
                    <div class="status-actions">
                        <span class="status-actions-label">[상태 변경하기]</span>
                        <button type="button" class="status-chip" data-status="available">바로 연결 가능</button>
                        <button type="button" class="status-chip" data-status="driving">운전 중</button>
                        <button type="button" class="status-chip" data-status="meeting">회의 중</button>
                        <button type="button" class="status-chip" data-status="away">잠시 불일</button>
                        <button type="button" class="status-chip" data-status="custom">직접 입력</button>
                    </div>
                    <div id="status-custom-editor" class="status-custom-editor" style="display:none;">
                        <input type="text" id="status-custom-input" class="status-custom-input"
                            placeholder="표시할 상태 메시지를 입력하세요." maxlength="50" />
                        <button type="button" id="status-custom-save" class="status-chip status-custom-save">저장</button>
                        <button type="button" id="status-custom-cancel" class="status-chip">취소</button>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h3>내 활동</h3>
                    <p>최근 활동 내역이 없습니다.</p>
                </div>
                <a href="notifications.html" class="card"
                    style="text-decoration: none; color: inherit; cursor: pointer;">
                    <h3>알림</h3>
                    <p>알림 목록을 확인하세요.</p>
                    <ul id="notification-preview-list" class="notification-preview">
                        <!-- JS로 최근 3개 렌더링 -->
                    </ul>
                </a>
                <a href="settings.html" class="card settings-card-link">
                    <h3>설정</h3>
                    <p id="settings-summary-default">차량 정보 및 연락처 관리</p>
                    <p id="settings-warning" class="settings-warning" style="display:none;">정보등록이 필요합니다.</p>
                    <p id="settings-vehicle" class="settings-info" style="display:none;">
                        차량번호: <span id="settings-vehicle-value"></span>
                    </p>
                    <p id="settings-phone" class="settings-info" style="display:none;">
                        휴대폰번호: <span id="settings-phone-value"></span>
                    </p>
                </a>
            </div>
        </main>
    </div>
    <script src="auth.js"></script>
    <script src="registration.js"></script>
    <script>
        // Check auth on load
        document.addEventListener('DOMContentLoaded', () => {
            const user = Auth.checkAuth();
            if (user) {
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('welcome-message').textContent = `${user.name}님, 환영합니다!`;

                // Set avatar if available, otherwise use a default
                if (user.avatar) {
                    document.getElementById('user-avatar').src = user.avatar;
                } else {
                    document.getElementById('user-avatar').src = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.name) + '&background=random';
                }

                // 설정 카드에 등록된 정보/경고 메시지 표시
                const defaultText = document.getElementById('settings-summary-default');
                const warningEl = document.getElementById('settings-warning');
                const vehicleRow = document.getElementById('settings-vehicle');
                const phoneRow = document.getElementById('settings-phone');
                const vehicleValEl = document.getElementById('settings-vehicle-value');
                const phoneValEl = document.getElementById('settings-phone-value');

                if (defaultText && warningEl && vehicleRow && phoneRow && vehicleValEl && phoneValEl) {
                    const hasVehicle = !!user.vehicleNumber;
                    const hasPhone = !!user.phoneNumber;

                    // 차량번호 표시
                    if (hasVehicle) {
                        vehicleValEl.textContent = user.vehicleNumber;
                    } else {
                        vehicleValEl.textContent = '등록이 필요합니다.';
                    }
                    vehicleRow.style.display = 'block';

                    // 휴대폰번호 표시
                    if (hasPhone) {
                        phoneValEl.textContent = user.phoneNumber;
                    } else {
                        phoneValEl.textContent = '등록이 필요합니다.';
                    }
                    phoneRow.style.display = 'block';

                    if (!hasVehicle && !hasPhone) {
                        // 둘 다 없으면 붉은 경고 메시지
                        warningEl.style.display = 'block';
                        defaultText.style.display = 'none';
                    } else {
                        // 하나라도 있으면 기본 설명만 숨김
                        warningEl.style.display = 'none';
                        defaultText.style.display = 'none';
                    }
                }

                // 알림 카드: 최근 3개 미리보기 (상대시간 + 자동 말줄임)
                const previewList = document.getElementById('notification-preview-list');
                if (previewList) {
                    const parseDateTime = (s) => {
                        // "YYYY-MM-DD HH:MM:SS" 파싱
                        const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/);
                        if (!m) return null;
                        const y = Number(m[1]);
                        const mo = Number(m[2]) - 1;
                        const d = Number(m[3]);
                        const hh = Number(m[4]);
                        const mm = Number(m[5]);
                        const ss = Number(m[6]);
                        return new Date(y, mo, d, hh, mm, ss);
                    };

                    const formatRelativeTime = (date) => {
                        if (!date || isNaN(date.getTime())) return '';
                        const now = new Date();
                        const diffMs = now.getTime() - date.getTime();
                        const diffSec = Math.floor(diffMs / 1000);

                        if (diffSec < 60) return '방금 전';
                        const diffMin = Math.floor(diffSec / 60);
                        if (diffMin < 60) return `${diffMin}분 전`;
                        const diffHour = Math.floor(diffMin / 60);
                        if (diffHour < 24) return `${diffHour}시간 전`;
                        const diffDay = Math.floor(diffHour / 24);
                        return `${diffDay}일 전`;
                    };

                    const formatSenderTail = (sender) => {
                        if (!sender) return '';
                        const parts = String(sender).split('-');
                        const last = parts[parts.length - 1] || String(sender).slice(-4);
                        return `...-${last}`;
                    };

                    // 샘플 데이터 (notifications.html의 최신 3개)
                    const notifications = [
                        {
                            time: '2026-02-10 10:38:12',
                            sender: '010-1111-0020',
                            message: '관리실로 방문해 주시기 바랍니다.'
                        },
                        {
                            time: '2026-02-10 10:32:54',
                            sender: '010-9090-0019',
                            message: '차량 주변에 공사 작업이 예정되어 있습니다.'
                        },
                        {
                            time: '2026-02-10 10:27:39',
                            sender: '010-8080-0018',
                            message: '충전 완료된 차량입니다. 이동을 부탁드립니다.'
                        }
                    ];

                    previewList.innerHTML = '';
                    notifications.slice(0, 3).forEach((n) => {
                        const dt = parseDateTime(n.time);
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span class="notification-preview-time">${formatRelativeTime(dt)}</span>
                            <span class="notification-preview-dot">·</span>
                            <span class="notification-preview-sender" title="${n.sender}">${formatSenderTail(n.sender)}</span>
                            <span class="notification-preview-dot">·</span>
                            <span class="notification-preview-message" title="${n.message}">${n.message}</span>
                        `;
                        previewList.appendChild(li);
                    });
                }

                // 상태 섹션 초기화
                const statusDot = document.getElementById('status-dot');
                const statusTitle = document.getElementById('status-title');
                const statusDesc = document.getElementById('status-description');
                const statusChips = document.querySelectorAll('.status-chip');
                const statusCustomEditor = document.getElementById('status-custom-editor');
                const statusCustomInput = document.getElementById('status-custom-input');
                const statusCustomSave = document.getElementById('status-custom-save');
                const statusCustomCancel = document.getElementById('status-custom-cancel');

                const STATUS_PRESETS = {
                    available: {
                        title: '바로 연결 가능',
                        description: '지금 누군가 호출하면 즉시 전화가 연결됩니다.',
                        dotClass: 'status-available'
                    },
                    driving: {
                        title: '운전 중',
                        description: '운전 중이어서 전화를 받기 어려울 수 있습니다.',
                        dotClass: 'status-driving'
                    },
                    meeting: {
                        title: '회의 중',
                        description: '회의 중이어서 전화를 받기 어렵습니다.',
                        dotClass: 'status-meeting'
                    },
                    away: {
                        title: '잠시 불일',
                        description: '잠시 자리를 비운 상태입니다.',
                        dotClass: 'status-away'
                    },
                    custom: {
                        title: '사용자 정의 상태',
                        description: '',
                        dotClass: 'status-custom'
                    }
                };

                const applyStatus = (statusKey, statusMessage) => {
                    const key = STATUS_PRESETS[statusKey] ? statusKey : 'available';
                    const preset = STATUS_PRESETS[key];

                    if (statusDot) {
                        statusDot.classList.remove('status-available', 'status-driving', 'status-meeting', 'status-away', 'status-custom');
                        statusDot.classList.add(preset.dotClass);
                    }
                    if (statusTitle) {
                        statusTitle.textContent = preset.title;
                    }
                    if (statusDesc) {
                        if (key === 'custom' && statusMessage) {
                            statusDesc.textContent = statusMessage;
                        } else {
                            statusDesc.textContent = preset.description;
                        }
                    }

                    if (statusChips && statusChips.length) {
                        statusChips.forEach((chip) => {
                            const chipKey = chip.getAttribute('data-status');
                            if (chipKey === key) {
                                chip.classList.add('status-chip-active');
                            } else {
                                chip.classList.remove('status-chip-active');
                            }
                        });
                    }
                };

                applyStatus(user.statusKey, user.statusMessage);

                if (statusChips && statusChips.length) {
                    const openCustomEditor = () => {
                        if (!statusCustomEditor || !statusCustomInput) return;
                        statusCustomEditor.style.display = 'flex';
                        statusCustomInput.value = user.statusMessage || '';
                        statusCustomInput.focus();
                    };

                    const closeCustomEditor = () => {
                        if (!statusCustomEditor || !statusCustomInput) return;
                        statusCustomEditor.style.display = 'none';
                        statusCustomInput.value = '';
                    };

                    const saveCustomStatus = async () => {
                        if (!statusCustomInput) return;
                        const value = statusCustomInput.value.trim();
                        if (!value) {
                            closeCustomEditor();
                            return;
                        }
                        try {
                            const updated = await Auth.updateUser({ statusKey: 'custom', statusMessage: value });
                            if (updated) {
                                user.statusKey = updated.statusKey;
                                user.statusMessage = updated.statusMessage;
                                applyStatus(user.statusKey, user.statusMessage);
                            }
                        } catch (e) {
                            console.error('Status update failed', e);
                            alert('상태 변경에 실패했습니다.');
                        }
                        closeCustomEditor();
                    };

                    statusChips.forEach((chip) => {
                        chip.addEventListener('click', async () => {
                            const key = chip.getAttribute('data-status');
                            if (!key) return;

                            if (key === 'custom') {
                                openCustomEditor();
                            } else {
                                try {
                                    const updated = await Auth.updateUser({ statusKey: key, statusMessage: '' });
                                    if (updated) {
                                        user.statusKey = updated.statusKey;
                                        user.statusMessage = updated.statusMessage;
                                        applyStatus(user.statusKey, user.statusMessage);
                                    }
                                } catch (e) {
                                    console.error('Status update failed', e);
                                    alert('상태 변경에 실패했습니다.');
                                }
                                closeCustomEditor();
                            }
                        });
                    });

                    if (statusCustomSave) {
                        statusCustomSave.addEventListener('click', saveCustomStatus);
                    }

                    if (statusCustomCancel) {
                        statusCustomCancel.addEventListener('click', () => {
                            closeCustomEditor();
                        });
                    }

                    if (statusCustomInput) {
                        statusCustomInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                saveCustomStatus();
                            } else if (e.key === 'Escape') {
                                e.preventDefault();
                                closeCustomEditor();
                            }
                        });
                    }
                }
            }

            document.getElementById('logout-btn').addEventListener('click', () => {
                Auth.logout();
            });
        });
    </script>
</body>

</html>